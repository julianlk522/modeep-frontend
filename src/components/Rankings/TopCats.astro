---
import { CATS_PAGE_LIMIT, MIN_LIST_ITEMS_FOR_SCROLLBAR } from '../../constants'
import type { CatCount, URLParams, tmap_sections } from '../../types'
import get_non_cats_url_params from '../Link/util/params'
import TagCat from '../Tag/TagCat'

interface Props {
    TopCats: CatCount[]
    URLParams: URLParams
    More?: boolean
    Mini?: boolean
    SingleTmapSection?: typeof tmap_sections[number]
    IsTmapFromUser?: string
}

const { 
    TopCats: top_cats, 
    URLParams: url_params,
    More: more, 
    Mini: mini, 
    SingleTmapSection: single_tmap_section,
    IsTmapFromUser: tmap_owner, 
} = Astro.props

let top_cats_classes = more ? ['more'] : tmap_owner ? ['tmap'] : []
if (mini) top_cats_classes.push('mini')
if (!more && top_cats?.length >= MIN_LIST_ITEMS_FOR_SCROLLBAR) top_cats_classes.push('scrollable')

const has_subcats = url_params.Cats ? true : false

let endpoint = tmap_owner ? `/map/${tmap_owner}` : "/search"
if (single_tmap_section) endpoint += `/${single_tmap_section}`

const non_cats_url_params = get_non_cats_url_params(url_params)
---

{top_cats?.length ? <div id="top-cats-container" class={`${tmap_owner ? 'tmap' : ''}${more ? ' more' : ''}`}>
    <h2 class={more ? 'more' : ''}>{
        has_subcats 
            ? 'Top Subcats' 
            : more 
                ? 'More Cats' 
                : 'Top Cats'
    }</h2>
    <ol id="top-cats" class={top_cats_classes.join(' ')}>
        {
            top_cats.map((cat) => {
                const new_cats_params = (url_params.Cats
                    ? url_params.Cats + ',' + cat.Category 
                    : cat.Category)
                .split(',')
                .sort((a, b) => a.localeCompare(b))
                .join(',')

                return <TagCat 
                    Cat={cat.Category} 
                    Count={cat.Count} 
                    IsNSFW={cat.Category === 'NSFW'} 
                    Href={`${endpoint}?cats=${new_cats_params}${non_cats_url_params.length ? `&${non_cats_url_params}` : ''}`}
                    IsMorePage={more}
                 />
            })
        }
    </ol>
    {top_cats.length === CATS_PAGE_LIMIT ? 
        <span id="to-more">
            <a href={has_subcats 
            ? `/more?cats=${url_params.Cats}${non_cats_url_params.length ? `&${non_cats_url_params}` : ''}` 
            : `/more${non_cats_url_params.length ? `?${non_cats_url_params}` : ''}`}>more
            </a>
            <img src='../../back.svg' alt="Go to /more" height={18} width={18} />
        </span> 
    : null}
</div> : has_subcats ? <p id="no-further-cats">No further subcats.</p> : null}

<style>
    #top-cats-container {
        padding-bottom: 1rem;
    }

    #top-cats-container.more {
        padding-bottom: 0;
    }

    #top-cats-container.tmap {
        width: 100%;
    }
    
    h2.more {
        margin: 0.5rem 0 0;
        padding-left: 1rem;
        padding-bottom: 0.25rem;
        border-bottom: var(--border-light);
    }

    ol#top-cats {
        max-height: 125px;
        padding-bottom: 0.5rem;
        gap: 3px;

        li.cat {
            list-style: normal;
        }

        li.cat::marker {
            font-weight: normal;
        }

        li.cat:last-child {
            padding-bottom: 2px;
        }
    }

    ol#top-cats.more {
        display: grid;
        grid-template-rows: repeat(100, 1fr);
        grid-template-columns: repeat(2, 1fr);
        grid-auto-flow: column;
        width: max-content;
        max-height: none;
        overflow-y: hidden;
        overflow-x: scroll;
        padding-inline-start: 1rem;

        li.cat.more {
            list-style-position: inside;
            padding-right: 5px;

            span {
                float: none;
                margin: 0;
            }
        }
    }

    span#to-more {
        display: block;
        list-style-type: none;
        margin-top: 0.5rem;
        text-align: center;
        font-size: 0.9rem;
        font-weight: bold;

        a {
            /* prevent extended underline */
            display: inline-block;
        }

        img {
            transform: rotate(180deg);
            margin-left: 3px;
            margin-bottom: -5px;
        }
    }

    p#no-further-cats {
        margin-top: 1rem;
        align-self: center;
    }

    @media (min-width: 350px) {
        ol#top-cats {
            gap: 5px;
        }

        ol#top-cats {
            max-height: 139px;
        }

        span#to-more {
            font-size: 1rem;
        }
    }

    @media (min-width: 480px) {
        ol#top-cats {
            max-height: 202px;
        }

        span#to-more {
            text-align: right;
        }
    }

    @media (min-width:680px) {
        ol#top-cats {
            max-height: 307px;
        }
    } 

    @media (min-width: 1000px) {
        ol#top-cats.more {
            grid-template-rows: repeat(50, 1fr);
            grid-template-columns: repeat(4, 1fr);
        }
    }
</style>